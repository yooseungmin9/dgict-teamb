<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>써머릭스 SUMMARIX</title>
    <link rel="stylesheet" href="/css/style.css"/>
    <link rel="stylesheet" href="/css/dashboard-grid.css"/>
    <link rel="stylesheet" href="/css/footer.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 반드시 opinion-widget.js보다 먼저 -->
    <script src="/js/wordcloud2.js"></script>
    <script defer src="/js/opinion-widget.js"></script>

    <!-- 나머지는 그대로 -->
    <script defer src="/js/sentiment.js"></script>
    <script defer src="/js/trands.js"></script>
    <script defer src="/js/app.js"></script>
    <script defer src="/js/headline.js"></script>
    <script defer src="/js/emoa.js"></script>
    <script defer src="/js/hot-topic.js"></script>
    <script defer src="/js/count.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script defer src="/js/clusters.js"></script>


    <!-- trands.js가 전역에서 읽어갈 API 경로(없으면 상대경로 기본값 사용) -->
    <script>
        window.API_ENDPOINTS = {
            sentimentLine: "/dashboard/sentiment/line",
            keywordRanking: "/dashboard/keywords/ranking",
            categoryTrend:  "/dashboard/trend/categories",
            emoaScore:      "/emoa/score"
        };
    </script>
</head>

<body data-page="dashboard"
      data-emoa-api="/api/dashboard/emoa/score"
      th:attr="data-require-interests=${session.loginUser != null and session.loginUser.interests == null}">
<div th:replace="fragments/header :: siteHeader"></div>

<main class="dash">
    <div class="container">
        <!-- 상단 속보 바 -->
        <div class="dash__headline">
            <section id="news-ticker" class="ticker-wrap"
                     data-api-base="http://127.0.0.1:8010"
                     data-q="미국 경제"
                     data-n="5"
                     data-sort="date">
                <div class="ticker-content" id="track-a" aria-label="뉴스 트랙 A"></div>
                <div class="ticker-content" id="track-b" aria-label="뉴스 트랙 B"></div>
            </section>
        </div>

        <!-- 3열 대시보드 -->
        <section class="dash__grid">
            <!-- 좌열 -->
            <div class="stack" id="col-left">
                <div class="card" id="panel-sentiment-series">
                    <strong class="strong">긍·부정추이</strong>
                    <article class="card__body">
                        <div class="feature-card" id="sentiment-card"
                             data-api="http://localhost:8007/sentiment/line">
                            <div class="controls" style="display:flex; gap:8px; align-items:center; margin-left:auto;">
                                <button id="btn-mode-count" class="btn btn--sm">건수</button>
                                <button id="btn-mode-ratio" class="btn btn--sm">비율</button>
                                <span style="margin: auto 10px; font-size: 20px;"> | </span>
                                <button id="btn-g-day"   class="btn btn--sm">일별</button>
                                <button id="btn-g-week"  class="btn btn--sm">주별</button>
                                <button id="btn-g-month" class="btn btn--sm">월별</button>
                            </div>
                            <div id="sentiment-status" style="font-size:12px;color:#666;margin:4px 0;">준비됨</div>
                            <div style="height:400px;">
                                <canvas id="sentiment-chart"></canvas>
                            </div>
                        </div>
                    </article>
                </div>
            </div>

            <!-- 중앙열 -->
            <div class="stack" id="col-center">
                <div class="card" id="panel-hot-topic-yesterday">
                    <strong class="strong">오늘의 키워드 핫토픽</strong>
                    <!-- ✅ placeholder 클래스 제거, hot-topic.js가 채움 -->
                    <div class="card__body" id="hot-topic-body">
                        <p style="text-align:center; color:#999;">로딩 중...</p>
                    </div>
                </div>

                <div class="card" id="panel-news-count">
                    <strong class="strong">분석된 기사 개수</strong>
                    <div class="card__body placeholder">카운트</div>
                </div>

                <div class="card" id="panel-today-sentiment">
                    <strong class="strong">오늘의 감성 요약</strong>
                    <div class="card__body" id="emoa-summary">
                        <p>데이터 수집 중...</p>
                    </div>
                </div>

                <div class="card" id="panel-ad">
                    <strong class="strong">광고</strong>
                    <a class="card__body ad-banner" href="https://www.saramin.co.kr/">
                        <div class="ad-content">
                            <h2>배너 광고 모집</h2>
                            <p>홈페이지 배너 광고 모집중 입니다.</p>
                        </div>
                    </a>
                </div>

                <div class="card" id="panel-clusters">
                    <strong class="strong">유사 기사 클러스터</strong>
                    <div class="card__body">
                        <div id="treemap" style="width:100%;height:520px;position:relative;">
                            <div id="cluster-overlay"></div>
                        </div>
                        <ol id="toplist" class="top10"></ol>
                    </div>
                </div>
            </div>

            <!-- 우열 -->
            <div class="stack" id="col-right">
                <div class="card" id="panel-keyword-rank">
                    <strong class="strong">키워드 랭킹</strong>
                    <div class="card__body">
                        <div class="controls" style="margin-bottom:6px;">
                            <label><input type="radio" name="DB_kwMode" value="category" checked /> 카테고리별</label>
                            <label><input type="radio" name="DB_kwMode" value="global" /> 통합</label>
                            <label class="muted">기간(일)
                                <select id="DB_kwDays">
                                    <option value="30" selected>30</option>
                                    <option value="60">60</option>
                                    <option value="90">90</option>
                                </select>
                            </label>
                        </div>
                        <div id="DB_kwTabs" style="margin:6px 0; display:flex; gap:6px; flex-wrap:wrap;"></div>
                        <table id="DB_kwTable" class="ranking-table">
                            <thead>
                            <tr>
                                <th style="width:64px;">순위</th>
                                <th>키워드</th>
                                <th class="right" style="width:100px;">언급량</th>
                            </tr>
                            </thead>
                            <tbody id="DB_keywordRankingBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="row-2">
                    <div class="card" id="panel-opinion">
                        <strong class="strong">오피니언 마이닝 요약</strong>
                        <div class="card__body" id="opinion-body" style="white-space: pre-wrap; line-height: 1.6; font-size: 14px;">
                            <p style="text-align:center;color:#999;">로딩 중...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 하단 트렌드 -->
            <div class="card" id="panel-hot-datalab">
                <div class="card__body">
                    <strong class="strong">키워드 핫토픽 그래프 (데이터랩)</strong>
                    <div class="controls" style="margin-bottom:8px;">
                        <label class="muted">표시 기간(일)
                            <select id="DB_trendDays">
                                <option value="30" selected>30</option>
                                <option value="60">60</option>
                                <option value="90">90</option>
                            </select>
                        </label>
                    </div>
                    <div class="chart-container">
                        <canvas id="DB_categoryTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>

<div th:replace="fragments/footer :: siteFooter"></div>

<script th:inline="javascript">
    (function () {
        function go(el) {
            var url = el.dataset.url;
            if (url) window.location.href = url;
        }
        function onClick(e) { go(e.currentTarget); }
        function onKey(e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); go(e.currentTarget); }
        }
        var links = document.querySelectorAll('[data-url]');
        links.forEach(function (el) {
            el.addEventListener('click', onClick);
            el.addEventListener('keydown', onKey);
            el.style.cursor = 'pointer';
        });
    })();
</script>

<!-- ===== 관심 키워드 온보딩 모달 ===== -->
<style>
    .modal-backdrop{
        position:fixed; inset:0; background:rgba(0,0,0,.5);
        display:none; align-items:center; justify-content:center; z-index:9999;
    }
    .modal-backdrop.open{display:flex;}
    .modal-card{
        width:min(960px, 92vw); max-height:90vh; overflow:auto;
        background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:20px 20px 16px;
        box-shadow:0 20px 60px rgba(0,0,0,.2);
    }
    .modal-head{display:flex; align-items:center; gap:10px; margin-bottom:10px}
    .modal-head h3{margin:0; font-size:18px}
    .modal-body{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:12px}
    .cat-card{border:1px solid #e5e7eb; border-radius:12px; padding:12px}
    .cat-title{font-weight:700; margin:0 0 6px}
    .kw-grid{display:flex; flex-wrap:wrap; gap:8px}
    .kw{border:1px solid #e5e7eb; border-radius:999px; padding:6px 10px; font-size:13px; cursor:pointer; user-select:none}
    .kw.active{background:#111827; color:#fff; border-color:#111827}
    .modal-foot{display:flex; justify-content:space-between; align-items:center; margin-top:12px}
    .muted{color:#6b7280; font-size:12px}
    .btn{border:1px solid #e5e7eb; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer}
    .btn.secondary{background:#fff; color:#111827}
    @media (max-width: 900px){ .modal-body{grid-template-columns:1fr 1fr} }
    @media (max-width: 640px){ .modal-body{grid-template-columns:1fr} }
</style>

<div id="interestModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="interestTitle">
        <div class="modal-head">
            <h3 id="interestTitle">관심 키워드를 선택하세요</h3>
            <span class="muted">최대 <b id="limitTotal">12</b>개 선택 가능</span>
        </div>

        <div id="interestRoot" class="modal-body"><!-- JS가 채움 --></div>

        <div class="modal-foot">
            <span class="muted">선택: <b id="selCount">0</b>개</span>
            <div style="display:flex; gap:8px">
                <button id="btnSkip" class="btn secondary">나중에</button>
                <button id="btnSave" class="btn">저장</button>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<style>
    .toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(20,20,20,0.9);
        color: #fff;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: 9999;
    }
    .toast.show { opacity: 1; pointer-events: auto; }
</style>

<script th:inline="javascript">
    (function(){
        // ===== 0) 환경 값 =====
        const MAX_TOTAL = 12;
        const MAX_PER_CAT = 4;

        // body data-* 로 주입: <body data-require-interests="true" data-user-id="${#authentication.name}">
        const need = document.body.getAttribute('data-require-interests') === 'true';
        const USER_ID = document.body.getAttribute('data-user-id') || 'guest';

        // (선택) CSRF 메타로 주입해두면 자동 포함
        const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;
        const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content;

        // ===== 1) 키워드 사전 =====
        const CATEGORY_KEYWORDS = {
            "증권": ["주식","코스피","ETF","공모주","배당","리츠","거래량"],
            "금융": ["금리","대출","예금","보험","환율","금융감독원","비트코인"],
            "부동산": ["부동산","아파트","전세","청약","재건축","공시지가","집값"],
            "산업": ["산업","자동차","반도체","전기차","배터리","로봇","AI"],
            "글로벌경제": ["미국","중국","달러","무역","유가","나스닥","IMF"],
            "일반": ["물가","소비","고용","임금","GDP","경기침체","가계부채"]
        };

        // ===== 2) 엘리먼트 =====
        const modal   = document.getElementById('interestModal');
        const root    = document.getElementById('interestRoot');
        const selCnt  = document.getElementById('selCount');
        const limitEl = document.getElementById('limitTotal');
        const btnSave = document.getElementById('btnSave');
        const btnSkip = document.getElementById('btnSkip');
        limitEl.textContent = String(MAX_TOTAL);

        // ===== 3) 상태 =====
        const state = {
            total: 0,
            perCat: {}, // { "증권": 0, ... }
        };

        // ===== 4) 렌더링 =====
        function render(){
            const frag = document.createDocumentFragment();
            Object.entries(CATEGORY_KEYWORDS).forEach(([cat, kws])=>{
                const card = document.createElement('section');
                card.className = 'cat-card';
                card.dataset.cat = cat;
                card.innerHTML = `
        <div class="cat-head">
          <h4 class="cat-title">${cat}</h4>
          <div class="cat-cap"><span class="cat-count">0</span> / ${MAX_PER_CAT}</div>
        </div>
      `;
                const box = document.createElement('div');
                box.className='kw-grid';

                kws.forEach(kw=>{
                    const chip = document.createElement('button');
                    chip.type = 'button';
                    chip.className='kw';
                    chip.textContent = kw;
                    chip.dataset.kw = kw;
                    chip.dataset.cat = cat;
                    chip.addEventListener('click', onToggle);
                    box.appendChild(chip);
                });

                // 섹션 초기화 버튼(선택)
                const tools = document.createElement('div');
                tools.className = 'cat-tools';
                const resetBtn = document.createElement('button');
                resetBtn.type='button';
                resetBtn.className='cat-reset';
                resetBtn.textContent='초기화';
                resetBtn.addEventListener('click', ()=>clearCategory(cat));
                tools.appendChild(resetBtn);

                card.appendChild(box);
                card.appendChild(tools);
                frag.appendChild(card);

                state.perCat[cat] = 0;
            });

            root.innerHTML = '';
            root.appendChild(frag);
            updateCounters();
        }

        // ===== 5) 선택/해제 로직 =====
        function countSelected(){ return root.querySelectorAll('.kw.active').length; }

        function onToggle(e){
            const el  = e.currentTarget;
            const cat = el.dataset.cat;

            // 해제
            if(el.classList.contains('active')){
                el.classList.remove('active');
                state.perCat[cat] = Math.max(0, state.perCat[cat]-1);
                state.total = Math.max(0, state.total-1);
                updateCounters();
                return;
            }

            // 선택 제한 체크
            if(state.total >= MAX_TOTAL) return;
            if(state.perCat[cat] >= MAX_PER_CAT) return;

            // 선택
            el.classList.add('active');
            state.perCat[cat] += 1;
            state.total += 1;
            updateCounters();
        }

        function clearCategory(cat){
            root.querySelectorAll(`.kw[data-cat="${cat}"].active`).forEach(el=>{
                el.classList.remove('active');
            });
            state.total -= state.perCat[cat];
            state.perCat[cat] = 0;
            if(state.total < 0) state.total = 0;
            updateCounters();
        }

        function updateCounters(){
            // 총계
            state.total = countSelected();
            selCnt.textContent = String(state.total);

            // 카테고리별
            Object.keys(state.perCat).forEach(cat=>{
                const cnt = root.querySelectorAll(`.kw[data-cat="${cat}"].active`).length;
                state.perCat[cat] = cnt;
                const card = root.querySelector(`.cat-card[data-cat="${cat}"]`);
                card?.querySelector('.cat-count')?.replaceChildren(document.createTextNode(String(cnt)));

                // cap 찬 후 아직 미선택인 칩들 비활성화
                const capReached = cnt >= MAX_PER_CAT;
                card?.querySelectorAll('.kw').forEach(chip=>{
                    if(chip.classList.contains('active')) {
                        chip.disabled = false; // 이미 선택된 것은 항상 활성
                    } else {
                        chip.disabled = capReached || state.total >= MAX_TOTAL;
                    }
                });
            });

            // 전체 cap에 따른 저장 버튼 상태
            btnSave.disabled = state.total > MAX_TOTAL;
        }

        // ===== 6) 열고/닫기 =====
        function open(){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
        function close(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }

        // ===== 7) 저장 =====
        function showToast(msg, ms=2000){
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), ms);
        }

        async function save(){
            const kws = Array.from(root.querySelectorAll('.kw.active')).map(el=>el.dataset.kw);
            const headers = { 'Content-Type':'application/json' };
            if(CSRF_HEADER && CSRF_TOKEN){ headers[CSRF_HEADER] = CSRF_TOKEN; }

            try{
                const res = await fetch('/member/interests', {
                    method:'POST',
                    headers,
                    body: JSON.stringify(kws)
                });
                if(!res.ok) throw new Error('save failed: ' + res.status);
                showToast('✅ 관심사가 저장되었습니다!');
                close();
            }catch(err){
                console.error(err);
                showToast('❌ 저장에 실패했습니다.', 3000);
            }
        }

        // ===== 8) 이벤트 =====
        btnSave.addEventListener('click', save);
        btnSkip.addEventListener('click', close);

        // ===== 9) 초기화 =====
        render();
        if(need) open();
    })();
</script>
</body>
</html>
