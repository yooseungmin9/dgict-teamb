<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>ì¨ë¨¸ë¦­ìŠ¤ SUMMARIX</title>
    <link rel="stylesheet" href="/css/style.css"/>
    <link rel="stylesheet" href="/css/dashboard-grid.css"/>
    <link rel="stylesheet" href="/css/footer.css"/>
    <link rel="stylesheet" href="/css/header.css"/>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="/js/wordcloud2.js"></script>
    <script defer src="/js/opinion-widget.js"></script>
    <script defer src="/js/sentiment.js"></script>
    <script defer src="/js/trends.js"></script>
    <script defer src="/js/app.js"></script>
    <script defer src="/js/headline.js"></script>
    <script defer src="/js/emoa.js"></script>
    <script defer src="/js/hot-topic.js"></script>
    <script defer src="/js/count.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script defer src="/js/clusters.js"></script>

    <script>
        window.API_ENDPOINTS = {
            sentimentLine: "/dashboard/sentiment/line",
            keywordRanking: "/dashboard/keywords/ranking",
            categoryTrend:  "/dashboard/trend/categories",
            emoaScore:      "/emoa/score"
        };
    </script>

    <style>
        :root{
            --brand:#2563eb; --bg:#fafafa; --panel:#ffffff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
            --ring: rgba(37,99,235,.35);
            --shadow-strong: 0 24px 80px rgba(0,0,0,.28);
            --shadow-soft: 0 10px 30px rgba(0,0,0,.12);
        }
        *,*::before,*::after{box-sizing:border-box}
        html,body{height:100%}
        body{margin:0;background:var(--bg);color:var(--ink);
            font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif;}
        a{color:var(--brand);text-decoration:none} a:hover{text-decoration:underline}
        .dash .container{max-width:1200px;margin:0 auto;padding:0 16px}

        /* partner grid */
        #partner-organization { padding: 24px 6%; }
        #partner-organization .strong { display:block;margin-bottom:16px;font-size:24px;font-weight:700;color:#1b2733; }
        .partner-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; justify-items:center; align-items:center; margin:0 auto; max-width:1000px; }
        .partner-card { display:flex; justify-content:center; align-items:center; background:#fff; border-radius:14px; box-shadow:0 3px 8px rgba(0,0,0,0.08); width:100%; height:90px; padding:8px 10px; transition:.2s; }
        .partner-card:hover { transform: translateY(-3px); box-shadow:0 6px 12px rgba(0,0,0,0.12); }
        .partner-card img { max-width:105%; max-height:100%; object-fit:contain; display:block; }
        .ranking-table th,.ranking-table td{ border-color: var(--line); }
        label input[type="radio"]{ accent-color: var(--brand); }

        /* ===== ë‹¨ì¼ ì˜¨ë³´ë”© ëª¨ë‹¬/í† ìŠ¤íŠ¸ ===== */
        .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(10,12,16,.38);backdrop-filter:blur(6px);z-index:9999;opacity:0;transition:opacity .22s ease}
        .modal-backdrop.open{display:flex;opacity:1}
        .modal-card{width:min(780px,92vw);max-height:88vh;overflow:auto;background:rgba(255,255,255,0.94);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow-strong);padding:18px}
        .modal-head{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line);padding-bottom:8px;margin-bottom:12px}
        .modal-body{display:grid;gap:14px}
        .section{border:1px solid var(--line);border-radius:12px;padding:12px}
        .section h4{margin:0 0 8px;font-size:15px}
        .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .cap{font-size:12px;color:var(--muted)}
        .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .btn{appearance:none;border:1px solid transparent;background:var(--brand);color:#fff;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer;transition:.16s;box-shadow:0 8px 18px rgba(37,99,235,.25)}
        .btn.secondary{background:#fff;color:var(--brand);border-color:#cbd5e1;box-shadow:none}
        .btn[disabled]{opacity:.5;cursor:not-allowed}
        .toast{position:fixed;left:50%;bottom:28px;transform:translateX(-50%);background:#0f1a33;color:#fff;padding:12px 18px;border-radius:10px;opacity:0;pointer-events:none;transition:.22s;z-index:10000}
        .toast.show{opacity:1;pointer-events:auto}

        /* === ì¹© ë²„íŠ¼ === */
        .chip{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 14px;font-size:13px;cursor:pointer;transition:.16s;display:inline-flex;align-items:center;gap:6px}
        .chip:hover{border-color: color-mix(in oklab, var(--brand) 35%, var(--line)); background:#f7faff}
        .chip.active{background:var(--brand);color:#fff;border-color:var(--brand);box-shadow:0 6px 16px rgba(37,99,235,.25)}
        .chip[disabled]{opacity:.5;cursor:not-allowed}
        .chip-set{display:flex;flex-wrap:wrap;gap:8px}
        .stack-v{display:flex;flex-direction:column;gap:10px}
    </style>
</head>

<body data-page="dashboard"
      data-emoa-api="/api/dashboard/emoa/score"
      th:attr="data-require-interests=${session.loginUser != null and session.loginUser.interests == null}">
<div th:replace="fragments/header :: siteHeader"></div>

<main class="dash">
    <div class="container">
        <!-- ìƒë‹¨ ì†ë³´ ë°” -->
        <div class="dash__headline">
            <section id="news-ticker" class="ticker-wrap"
                     data-api-base="http://127.0.0.1:8010"
                     data-q="ë¯¸êµ­ ê²½ì œ"
                     data-n="5"
                     data-sort="date">
                <div class="ticker-content" id="track-a" aria-label="ë‰´ìŠ¤ íŠ¸ë™ A"></div>
                <div class="ticker-content" id="track-b" aria-label="ë‰´ìŠ¤ íŠ¸ë™ B"></div>
            </section>
        </div>

        <!-- 3ì—´ ëŒ€ì‹œë³´ë“œ -->
        <section class="dash__grid">
            <!-- ì¢Œì—´ -->
            <div class="stack" id="col-left">
                <div class="card" id="panel-sentiment-series">
                    <strong class="strong">ê¸Â·ë¶€ì •ì¶”ì´</strong>
                    <article class="card__body">
                        <div class="feature-card" id="sentiment-card" data-api="http://localhost:8007/sentiment/line">
                            <div class="controls" style="display:flex; gap:8px; align-items:center; margin-left:auto;">
                                <button id="btn-mode-count" class="chip">ê±´ìˆ˜</button>
                                <button id="btn-mode-ratio" class="chip">ë¹„ìœ¨</button>
                                <span style="margin: auto 10px; font-size: 20px;"> | </span>
                                <button id="btn-g-day" class="chip">ì¼ë³„</button>
                                <button id="btn-g-week" class="chip">ì£¼ë³„</button>
                                <button id="btn-g-month" class="chip">ì›”ë³„</button>
                            </div>
                            <div id="sentiment-status" style="font-size:12px;color:#666;margin:4px 0;">ì¤€ë¹„ë¨</div>
                            <div style="height:400px;"><canvas id="sentiment-chart"></canvas></div>
                        </div>
                    </article>
                </div>
            </div>

            <!-- ì¤‘ì•™ì—´ -->
            <div class="stack" id="col-center">
                <div class="card" id="panel-hot-topic-yesterday">
                    <strong class="strong">ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œ í•«í† í”½</strong>
                    <div class="card__body" id="hot-topic-body"><p style="text-align:center; color:#999;">ë¡œë”© ì¤‘...</p></div>
                </div>

                <div class="card" id="panel-news-count">
                    <strong class="strong">ë¶„ì„ëœ ê¸°ì‚¬ ê°œìˆ˜</strong>
                    <div class="card__body placeholder">ì¹´ìš´íŠ¸</div>
                </div>

                <div class="card" id="panel-today-sentiment">
                    <strong class="strong">ì˜¤ëŠ˜ì˜ ê°ì„± ìš”ì•½</strong>
                    <div class="card__body" id="emoa-summary"><p>ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</p></div>
                </div>

                <div class="card" id="partner-organization">
                    <strong class="strong">í˜‘ë ¥ê¸°ê´€</strong>
                    <section id="partners" class="partner-grid">
                        <a href="https://www.daegu.go.kr/" target="_blank" class="partner-card"><img src="/img/daegu.png" alt="ëŒ€êµ¬ê´‘ì—­ì‹œ ë¡œê³ " /></a>
                        <a href="https://www.suseong.kr/" target="_blank" class="partner-card"><img src="/img/susung.png" alt="ìˆ˜ì„±êµ¬ ë¡œê³ " /></a>
                        <a href="https://alphacity.or.kr/index" target="_blank" class="partner-card"><img src="/img/alphacity.png" alt="ìˆ˜ì„±ì•ŒíŒŒì‹œí‹° ë¡œê³ " /></a>
                        <a href="https://dgict.org/" target="_blank" class="partner-card"><img src="/img/dgict.png" alt="ëŒ€ê²½ICTì‚°ì—…í˜‘íšŒ ë¡œê³ " /></a>
                        <a href="https://www.dip.or.kr/home/main.ubs" target="_blank" class="partner-card"><img src="/img/dip.png" alt="ëŒ€êµ¬ë””ì§€í„¸í˜ì‹ ì§„í¥ì› ë¡œê³ " /></a>
                        <a href="https://dgtp.or.kr/" target="_blank" class="partner-card"><img src="/img/dgtp.png" alt="ëŒ€êµ¬í…Œí¬ë…¸íŒŒí¬ ë¡œê³ " /></a>
                        <a href="https://www.alphacity.or.kr/boardView?board_id=69" target="_blank" class="partner-card"><img src="/img/koreawide.png" alt="ì½”ë¦¬ì•„ì™€ì´ë“œ ë¡œê³ " /></a>
                        <a href="https://www.yhdatabase.com/main.do" target="_blank" class="partner-card"><img src="/img/yhdatabase.png" alt="YHë°ì´í„°ë² ì´ìŠ¤ ë¡œê³ " /></a>
                        <a href="https://www.igis.co.kr/" target="_blank" class="partner-card"><img src="/img/igis.png" alt="ì•„ì´ì§€ì•„ì´ì—ìŠ¤ ë¡œê³ " /></a>
                        <a href="http://www.sillasystem.com/main.php" target="_blank" class="partner-card"><img src="/img/sillasystem.png" alt="ì‹ ë¼ì‹œìŠ¤í…œ ë¡œê³ " /></a>
                        <a href="http://www.bumil.co.kr" target="_blank" class="partner-card"><img src="/img/bumil.png" alt="ë²”ì¼ì •ë³´ ë¡œê³ " /></a>
                        <a href="https://computermate.co.kr/kor" target="_blank" class="partner-card"><img src="/img/computermate.png" alt="ì»´í“¨í„°ë©”ì´íŠ¸ ë¡œê³ " /></a>
                    </section>
                </div>

                <div class="card" id="panel-clusters">
                    <strong class="strong">ìœ ì‚¬ ê¸°ì‚¬ í´ëŸ¬ìŠ¤í„°</strong>
                    <div class="card__body">
                        <div id="treemap" style="width:100%;height:520px;position:relative;">
                            <div id="cluster-overlay"></div>
                        </div>
                        <ol id="toplist" class="top10"></ol>
                    </div>
                </div>
            </div>

            <!-- ìš°ì—´ -->
            <div class="stack" id="col-right">
                <div class="card" id="panel-keyword-rank">
                    <strong class="strong">í‚¤ì›Œë“œ ë­í‚¹</strong>
                    <div class="card__body">
                        <div class="controls" style="margin-bottom:6px;">
                            <label><input type="radio" name="DB_kwMode" value="category" checked /> ì¹´í…Œê³ ë¦¬ë³„</label>
                            <label><input type="radio" name="DB_kwMode" value="global" /> í†µí•©</label>
                            <label class="muted">ê¸°ê°„(ì¼)
                                <select id="DB_kwDays">
                                    <option value="30" selected>30</option>
                                    <option value="60">60</option>
                                    <option value="90">90</option>
                                </select>
                            </label>
                        </div>
                        <div id="DB_kwTabs" style="margin:6px 0; display:flex; gap:6px; flex-wrap:wrap;"></div>
                        <table id="DB_kwTable" class="ranking-table">
                            <thead><tr><th style="width:64px;">ìˆœìœ„</th><th>í‚¤ì›Œë“œ</th><th class="right" style="width:100px;">ì–¸ê¸‰ëŸ‰</th></tr></thead>
                            <tbody id="DB_keywordRankingBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="row-2">
                    <div class="card" id="panel-opinion">
                        <strong class="strong">ì˜¤í”¼ë‹ˆì–¸ ë§ˆì´ë‹ ìš”ì•½</strong>
                        <div class="card__body" id="opinion-body" style="white-space: pre-wrap; line-height: 1.6; font-size: 14px;">
                            <p style="text-align:center;color:#999;">ë¡œë”© ì¤‘...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" id="panel-hot-datalab">
                <div class="card__body">
                    <strong class="strong">í‚¤ì›Œë“œ í•«í† í”½ ê·¸ë˜í”„ (ë°ì´í„°ë©)</strong>
                    <div class="controls" style="margin-bottom:8px;">
                        <label class="muted">í‘œì‹œ ê¸°ê°„(ì¼)
                            <select id="DB_trendDays">
                                <option value="30" selected>30</option>
                                <option value="60">60</option>
                                <option value="90">90</option>
                            </select>
                        </label>
                    </div>
                    <div class="chart-container"><canvas id="DB_categoryTrendChart"></canvas></div>
                </div>
            </div>
        </section>
    </div>
</main>

<div th:replace="fragments/footer :: siteFooter"></div>

<!-- ===== ë‹¨ì¼ ì˜¨ë³´ë”© ëª¨ë‹¬ (ê´€ì‹¬ í‚¤ì›Œë“œ + ì´ìš©ê²½ë¡œ/í”Œë«í¼/ì¹©) ===== -->
<div id="onboardModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="onboardTitle">
        <div class="modal-head">
            <h3 id="onboardTitle" style="margin:0;font-size:18px;font-weight:800">ë§ì¶¤ ë‰´ìŠ¤ ì„¤ì •</h3>
            <span class="cap">ì•„ë˜ ë‘ ê°€ì§€ë§Œ ê³¨ë¼ì£¼ì„¸ìš” (1ë¶„)</span>
        </div>

        <div class="modal-body">
            <!-- 1) ê´€ì‹¬ í‚¤ì›Œë“œ -->
            <section class="section">
                <div class="grid-2">
                    <div>
                        <h4>ê´€ì‹¬ í‚¤ì›Œë“œ</h4>
                        <div class="cap">ìµœëŒ€ <b id="capTotal">12</b>ê°œ Â· ì¹´í…Œê³ ë¦¬ë‹¹ 4ê°œ</div>
                    </div>
                    <div class="cap" style="text-align:right">ì„ íƒ: <b id="selCount">0</b>ê°œ</div>
                </div>
                <div id="kwRoot" class="grid-2" style="margin-top:8px"><!-- JSê°€ ì±„ì›€ --></div>
            </section>

            <!-- 2) ì´ìš© ê²½ë¡œ/í”Œë«í¼ (ì¹© UI, ì„¸ë¡œ ìŠ¤íƒ) -->
            <section class="section">
                <h4>ë‰´ìŠ¤ë¥¼ ì£¼ë¡œ ì–´ë””ì„œ ë³´ì„¸ìš”?</h4>

                <div class="stack-v" style="margin-top:6px">
                    <div>
                        <div class="cap" style="margin-bottom:6px">ì£¼ìš” ì´ìš©ê²½ë¡œ</div>
                        <div class="chip-set" data-group="mainSource" data-type="multi">
                            <button class="chip" data-value="portal">í¬í„¸</button>
                            <button class="chip" data-value="sns">SNS</button>
                            <button class="chip" data-value="youtube">YouTube</button>
                            <button class="chip" data-value="ott">OTT</button>
                            <button class="chip" data-value="pressSite">ì–¸ë¡ ì‚¬ ì‚¬ì´íŠ¸</button>
                        </div>
                    </div>

                    <div>
                        <div class="cap" style="margin-bottom:6px">í¬í„¸</div>
                        <div class="chip-set" data-group="portal" data-type="multi">
                            <button class="chip" data-value="Naver">Naver</button>
                            <button class="chip" data-value="Daum">Daum</button>
                            <button class="chip" data-value="Google">Google</button>
                        </div>
                    </div>

                    <div>
                        <div class="cap" style="margin-bottom:6px">SNS</div>
                        <div class="chip-set" data-group="sns" data-type="multi">
                            <button class="chip" data-value="Instagram">Instagram</button>
                            <button class="chip" data-value="X">X</button>
                            <button class="chip" data-value="TikTok">TikTok</button>
                        </div>
                    </div>

                    <div>
                        <div class="cap" style="margin-bottom:6px">ë¹„ë””ì˜¤</div>
                        <div class="chip-set" data-group="video" data-type="multi">
                            <button class="chip" data-value="YouTube">YouTube</button>
                            <button class="chip" data-value="TikTok">TikTok</button>
                        </div>
                    </div>

                    <div>
                        <div class="cap" style="margin-bottom:6px">OTT</div>
                        <div class="chip-set" data-group="ott" data-type="multi">
                            <button class="chip" data-value="Netflix">Netflix</button>
                            <button class="chip" data-value="Tving">Tving</button>
                        </div>
                    </div>

                    <div class="cap" style="margin-top:2px">* â€˜í¬í„¸â€™ ì„ íƒì€ **ì£¼ìš” ì´ìš©ê²½ë¡œê°€ í¬í„¸ì¼ ë•Œë§Œ** í•¨ê»˜ ì €ì¥ë©ë‹ˆë‹¤.</div>
                </div>

            </section>

            <div class="controls" style="justify-content:flex-end">
                <button id="btnLater" class="btn secondary">ë‚˜ì¤‘ì—</button>
                <button id="btnSaveAll" class="btn">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script th:inline="javascript">
    (function(){
        const API_BASE = ''; // ì»¨í…ìŠ¤íŠ¸ ê²½ë¡œê°€ ìˆìœ¼ë©´ '/api' ë“±ìœ¼ë¡œ ë³€ê²½
        const need = document.body.getAttribute('data-require-interests') === 'true';

        const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;
        const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content;
        const headersJSON = {'Content-Type':'application/json'};
        if (CSRF_HEADER && CSRF_TOKEN) headersJSON[CSRF_HEADER] = CSRF_TOKEN;

        // ===== ë§í¬ ì¹´ë“œ ì ‘ê·¼ì„±(ì›ë³¸ ìœ ì§€)
        (function () {
            function go(el) { var url = el.dataset.url; if (url) window.location.href = url; }
            function onClick(e) { go(e.currentTarget); }
            function onKey(e) { if (e.key==='Enter'||e.key===' '){ e.preventDefault(); go(e.currentTarget); } }
            var links = document.querySelectorAll('[data-url]');
            links.forEach(function (el) {
                el.addEventListener('click', onClick);
                el.addEventListener('keydown', onKey);
                el.style.cursor = 'pointer';
            });
        })();

        // ===== ëª¨ë‹¬/í† ìŠ¤íŠ¸
        const modal = document.getElementById('onboardModal');
        const toast = document.getElementById('toast');
        const open  = ()=>{ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); };
        const close = ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); };
        const showToast = (m,ms=2000)=>{ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),ms); };

        // ===== ê´€ì‹¬ í‚¤ì›Œë“œ
        const MAX_TOTAL=12, MAX_PER_CAT=4;
        document.getElementById('capTotal').textContent = MAX_TOTAL;
        const KW_DICT = {
            "ì¦ê¶Œ": ["ì£¼ì‹","ì½”ìŠ¤í”¼","ETF","ê³µëª¨ì£¼","ë°°ë‹¹","ë¦¬ì¸ ","ê±°ë˜ëŸ‰"],
            "ê¸ˆìœµ": ["ê¸ˆë¦¬","ëŒ€ì¶œ","ì˜ˆê¸ˆ","ë³´í—˜","í™˜ìœ¨","ê¸ˆìœµê°ë…ì›","ë¹„íŠ¸ì½”ì¸"],
            "ë¶€ë™ì‚°": ["ë¶€ë™ì‚°","ì•„íŒŒíŠ¸","ì „ì„¸","ì²­ì•½","ì¬ê±´ì¶•","ê³µì‹œì§€ê°€","ì§‘ê°’"],
            "ì‚°ì—…": ["ì‚°ì—…","ìë™ì°¨","ë°˜ë„ì²´","ì „ê¸°ì°¨","ë°°í„°ë¦¬","ë¡œë´‡","AI"],
            "ê¸€ë¡œë²Œê²½ì œ": ["ë¯¸êµ­","ì¤‘êµ­","ë‹¬ëŸ¬","ë¬´ì—­","ìœ ê°€","ë‚˜ìŠ¤ë‹¥","IMF"],
            "ì¼ë°˜": ["ë¬¼ê°€","ì†Œë¹„","ê³ ìš©","ì„ê¸ˆ","GDP","ê²½ê¸°ì¹¨ì²´","ê°€ê³„ë¶€ì±„"]
        };
        const kwRoot   = document.getElementById('kwRoot');
        const selCntEl = document.getElementById('selCount');
        const state    = { total:0, perCat:{} };

        function renderKW(){
            const frag = document.createDocumentFragment();
            Object.entries(KW_DICT).forEach(([cat, kws])=>{
                state.perCat[cat]=0;
                const wrap=document.createElement('div');
                wrap.innerHTML = `<div class="cap" style="margin-bottom:6px"><b>${cat}</b> Â· <span data-cap="${cat}">0</span> / ${MAX_PER_CAT}</div>`;
                const box=document.createElement('div'); box.className='chip-set';
                kws.forEach(kw=>{
                    const b=document.createElement('button');
                    b.type='button'; b.className='chip'; b.textContent=kw;
                    b.dataset.kw=kw; b.dataset.cat=cat;
                    b.addEventListener('click', onToggleKW);
                    box.appendChild(b);
                });
                wrap.appendChild(box);
                frag.appendChild(wrap);
            });
            kwRoot.replaceChildren(frag);
            syncCounts();
        }

        function onToggleKW(e){
            const el=e.currentTarget, cat=el.dataset.cat;
            const active=el.classList.contains('active');
            if(active){
                el.classList.remove('active');
                state.perCat[cat]=Math.max(0,state.perCat[cat]-1);
            }else{
                if(state.total>=MAX_TOTAL) return;
                if(state.perCat[cat]>=MAX_PER_CAT) return;
                el.classList.add('active');
                state.perCat[cat]+=1;
            }
            syncCounts();
        }

        function syncCounts(){
            state.total = kwRoot.querySelectorAll('.chip.active[data-kw]').length;
            selCntEl.textContent = String(state.total);
            Object.keys(state.perCat).forEach(cat=>{
                const cnt = kwRoot.querySelectorAll(`.chip.active[data-cat="${cat}"]`).length;
                state.perCat[cat]=cnt;
                const span=kwRoot.querySelector(`[data-cap="${cat}"]`); if(span) span.textContent=cnt;
                const capReached = cnt>=MAX_PER_CAT;
                kwRoot.querySelectorAll(`.chip[data-cat="${cat}"]`).forEach(btn=>{
                    if(btn.classList.contains('active')) btn.disabled=false;
                    else btn.disabled = capReached || state.total>=MAX_TOTAL;
                });
            });
        }

        // ===== ì¹© ê·¸ë£¹(ë‹¨ì¼/ë³µìˆ˜) í•¸ë“¤ëŸ¬
        document.querySelectorAll('.chip-set').forEach(set=>{
            set.addEventListener('click', (e)=>{
                const btn = e.target.closest('.chip'); if(!btn) return;
                const type = set.dataset.type || 'multi';
                if(type === 'single'){
                    set.querySelectorAll('.chip.active').forEach(el=>el.classList.remove('active'));
                    btn.classList.add('active');
                }else{
                    btn.classList.toggle('active');
                }
            });
        });

        // ===== ê°’ ìˆ˜ì§‘
        function getSingle(group){
            const el = document.querySelector(`.chip-set[data-group="${group}"] .chip.active`);
            return el ? el.dataset.value : null;
        }
        function getMulti(group){
            return [...document.querySelectorAll(`.chip-set[data-group="${group}"] .chip.active`)]
                .map(el => el.dataset.value);
        }
        function firstOrNull(arr){ return (arr && arr.length>0) ? arr[0] : null; }

        // ğŸ‘‰ ë‹¤ì¤‘ì„ íƒ ë°˜ì˜: mainSources/portals ë°°ì—´ + ë‹¨ì¼(ì²« ê°’) ë™ì‹œ ì „ì†¡
        function collectPrefs(){
            const mainSources = getMulti('mainSource'); // ["portal","youtube",...]
            const portals     = getMulti('portal');     // ["Naver","Google",...]

            const sns   = getMulti('sns');
            const video = getMulti('video');
            const ott   = getMulti('ott');

            return {
                // ì‹ ê·œ ë‹¤ì¤‘
                mainSources,
                portals,
                sns, video, ott,

                // í•˜ìœ„í˜¸í™˜(ë‹¨ì¼): í•„ìš”í•˜ë©´ ë°±ì—”ë“œê°€ ê³„ì† ì½ì„ ìˆ˜ ìˆë„ë¡ ì²« ìš”ì†Œë¡œ ì±„ì›€
                mainSource: firstOrNull(mainSources),
                portal:     firstOrNull(portals)
            };
        }

        // ===== ì €ì¥(1íšŒ í´ë¦­) : interests â†’ preferences ì—°ì† í˜¸ì¶œ
        document.getElementById('btnSaveAll').addEventListener('click', async ()=>{
            const keywords = Array.from(kwRoot.querySelectorAll('.chip.active[data-kw]'))
                .map(el=>el.dataset.kw);
            const prefsBody = collectPrefs();

            try{
                const r1 = await fetch(`${API_BASE}/member/interests`, {
                    method:'POST', headers: headersJSON, body: JSON.stringify(keywords)
                });
                if(!r1.ok) throw new Error('interests '+r1.status);

                const r2 = await fetch(`${API_BASE}/member/preferences`, {
                    method:'POST', headers: headersJSON, body: JSON.stringify(prefsBody)
                });
                if(!r2.ok) throw new Error('preferences '+r2.status);

                showToast('âœ… ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                close();
                // location.reload(); // í•„ìš” ì‹œ ì£¼ì„ í•´ì œ
            }catch(err){
                console.error(err, {keywords, prefsBody});
                showToast('âŒ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 3000);
            }
        });

        document.getElementById('btnLater').addEventListener('click', close);

        // ===== ì´ˆê¸°í™”: ê´€ì‹¬ì‚¬ê°€ ì—†ìœ¼ë©´ ìë™ ì˜¤í”ˆ
        renderKW();
        if(need) open();
    })();
</script>

</body>
</html>
