<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>써머릭스 SUMMARIX</title>
    <link rel="stylesheet" href="/css/style.css"/>
    <link rel="stylesheet" href="/css/dashboard-grid.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="/js/sentiment.js"></script>
    <script defer src="/js/trands.js"></script>
    <script defer src="/js/app.js"></script>
</head>
<body data-page="dashboard">
<div th:replace="fragments/header :: siteHeader"></div>

<main class="dash">
    <div class="container">

        <div class="dash__headline">
            <h2 th:text="${mainPageTitle != null ? mainPageTitle : '~ 글로벌 뉴스 속보 모니터링 ~'}">~ 글로벌 뉴스 속보 모니터링 ~</h2>
        </div>

        <div>
            <button class="report-btn" type="button" id="aiReportBtn">AI 리포트 생성</button>
        </div>

        <section class="dash__grid">
            <!-- 좌열 -->
            <div class="stack" id="col-left">
                <div class="card" id="panel-sentiment-series">
                    <article class="card__body">
                        <div class="feature-card" id="sentiment-card"
                             data-api="http://127.0.0.1:8000/sentiment/line">
                            <strong>긍·부정추이</strong>
                            <div class="controls" style="display:flex; gap:8px; align-items:center; margin-left:auto;">
                                <button id="btn-mode-count" class="btn btn--sm">건수</button>
                                <button id="btn-mode-ratio" class="btn btn--sm">비율</button>
                                <button id="btn-g-day"   class="btn btn--sm">일별</button>
                                <button id="btn-g-week"  class="btn btn--sm">주별</button>
                                <button id="btn-g-month" class="btn btn--sm">월별</button>
                            </div>
                            <div id="sentiment-status" style="font-size:12px;color:#666;margin:4px 0;">준비됨</div>
                            <div style="height:400px;">
                                <canvas id="sentiment-chart"></canvas>
                            </div>
                        </div>
                    </article>
                </div>
            </div>

            <!-- 중앙열 -->
            <div class="stack" id="col-center">
                <div class="card" id="panel-hot-topic-yesterday">
                    <div class="card__title">키워드 핫토픽 (어제 대비)</div>
                    <div class="card__body placeholder">핫토픽 리스트/차트</div>
                </div>

                <div class="card" id="panel-news-count">
                    <div class="card__title">분석된 뉴스 개수</div>
                    <div class="card__body placeholder">카운트/스파크라인</div>
                </div>

                <div class="card" id="panel-today-sentiment">
                    <div class="card__title">오늘의 감성점수 수집된것 (백분율)</div>
                    <div class="card__body placeholder">파이/도넛</div>
                </div>

                <div class="card" id="panel-tbd">
                    <div class="card__title">미정</div>
                    <div class="card__body placeholder">추후 위젯</div>
                </div>
            </div>

            <!-- 우열 -->
            <div class="stack" id="col-right">
                <div class="card" id="panel-keyword-rank">
                    <div class="card__body">
                        <strong>키워드 랭킹</strong>

                        <div class="controls" style="margin-bottom:6px;">
                            <label><input type="radio" name="DB_kwMode" value="category" checked /> 카테고리별</label>
                            <label><input type="radio" name="DB_kwMode" value="global" /> 통합</label>
                            <label class="muted">기간(일)
                                <select id="DB_kwDays">
                                    <option value="30" th:selected="${days==30}">30</option>
                                    <option value="60" th:selected="${days==60}">60</option>
                                    <option value="90" th:selected="${days==90}">90</option>
                                </select>
                            </label>
                        </div>

                        <!-- 선택된 카테고리 표시 (없으면 '전체') -->
                        <div class="muted" style="margin:4px 0;"
                             th:text="'카테고리: ' + (${category} != null ? ${category} : '전체')">카테고리: 전체</div>

                        <table id="DB_kwTable" class="ranking-table">
                            <thead>
                            <tr>
                                <th style="width:64px;">순위</th>
                                <th>키워드</th>
                                <th class="right" style="width:100px;">언급량</th>
                            </tr>
                            </thead>
                            <tbody id="DB_keywordRankingBody">
                            <!-- 서버에서 내려준 리스트로 바로 렌더 -->
                            <tr th:each="r : ${keywordRanking}">
                                <td th:text="${r.rank}">1</td>
                                <td th:text="${r.keyword}">예시키워드</td>
                                <td class="right" th:text="${r.count}">123</td>
                            </tr>
                            <!-- 비어있을 때 -->
                            <tr th:if="${#lists.isEmpty(keywordRanking)}">
                                <td colspan="3">데이터가 없습니다.</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row-2">
                    <div class="card" id="panel-opinion">
                        <div class="card__title">오피니언 마이닝 요약</div>
                        <div class="card__body placeholder">요약 텍스트</div>
                    </div>
                </div>
            </div>

            <!-- 데이터랩 라인차트 -->
            <div class="card" id="panel-hot-datalab">
                <div class="card__body">
                    <strong>키워드 핫토픽 그래프 (데이터랩)</strong>
                    <div class="controls" style="margin-bottom:8px;">
                        <label class="muted">표시 기간(일)
                            <select id="DB_trendDays">
                                <option value="30" th:selected="${days==30}">30</option>
                                <option value="60" th:selected="${days==60}">60</option>
                                <option value="90" th:selected="${days==90}">90</option>
                            </select>
                        </label>
                    </div>
                    <div class="chart-container">
                        <canvas id="DB_categoryTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>

<!-- 유틸: data-url 클릭 이동 -->
<script>
    (function () {
        function go(el) { var url = el.dataset.url; if (url) window.location.href = url; }
        function onClick(e) { go(e.currentTarget); }
        function onKey(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); go(e.currentTarget); } }
        var links = document.querySelectorAll('[data-url]');
        links.forEach(function (el) {
            el.addEventListener('click', onClick);
            el.addEventListener('keydown', onKey);
            el.style.cursor = 'pointer';
        });
    })();
</script>

<!-- 대시보드 초기 데이터 렌더링 -->
<script th:inline="javascript">
    (() => {
        let trendChart;

        const ctx = document.getElementById('DB_categoryTrendChart');
        const $daysSel = document.getElementById('DB_trendDays');

        function toDatasetsFromServerJson(json) {
            // 서버가 Chart.js 형태({labels:[], datasets:[]})로 줄 수도 있고,
            // 커스텀 형식으로 줄 수도 있으니 최대한 유연하게 변환
            try {
                const data = (typeof json === 'string') ? JSON.parse(json) : json;

                // 1) 이미 Chart.js 포맷
                if (data && Array.isArray(data.labels) && Array.isArray(data.datasets)) {
                    return { labels: data.labels, datasets: data.datasets };
                }

                // 2) {dates:[], series:{카테고리:[..]}} 또는 {result:[{date, series:{...}}]}
                if (Array.isArray(data.dates) && data.series && typeof data.series === 'object') {
                    const labels = data.dates;
                    const datasets = Object.keys(data.series).map(k => ({
                        label: k, data: data.series[k]
                    }));
                    return { labels, datasets };
                }

                if (Array.isArray(data.result)) {
                    const labels = data.result.map(r => r.date || r.label);
                    // 시리즈 키 자동 추출
                    const keys = Object.keys(data.result[0] || {}).filter(k => k !== 'date' && k !== 'label');
                    const datasets = keys.map(k => ({
                        label: k,
                        data: data.result.map(r => r[k] ?? 0)
                    }));
                    return { labels, datasets };
                }
            } catch (e) {
                console.warn('trend json parse error', e);
            }
            return { labels: [], datasets: [] };
        }

        async function loadTrend(days) {
            try {
                const resp = await fetch(`/api/dashboard/category-trends?days=${encodeURIComponent(days)}&time_unit=date`);
                const text = await resp.text(); // FastAPI가 문자열 JSON 반환하므로 우선 text로
                const parsed = toDatasetsFromServerJson(text);

                if (trendChart) trendChart.destroy();
                trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: parsed.labels,
                        datasets: parsed.datasets.map(ds => ({
                            label: ds.label,
                            data: ds.data,
                            fill: false,
                            tension: 0.2
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: { x: { ticks: { maxTicksLimit: 12 } } }
                    }
                });
            } catch (err) {
                console.error('trend fetch error', err);
            }
        }

        // 초기 로드 (서버 모델 값 days 사용)
        const initDays = /*[[${days}]]*/ 30;
        loadTrend(initDays);

        // 기간 변경 시 재로드
        $daysSel.addEventListener('change', () => loadTrend($daysSel.value));
    })();
</script>

</body>
</html>
