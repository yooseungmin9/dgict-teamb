<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>ì˜¤ëŠ˜ì˜ ê²½ì œ ë‰´ìŠ¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <link rel="stylesheet" href="/css/footer.css"/>

  <style>
    /* ===== ë‰´ìŠ¤ ì¹´ë“œ(ê¸°ì¡´ ë””ìì¸ ìœ ì§€) ===== */
    #news-page .news-list{max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:16px}
    #news-page .news-card{border:1px solid #e5e7eb;border-radius:14px;background:#fff;padding:16px;display:flex;gap:16px;align-items:flex-start;transition:box-shadow .18s}
    #news-page .news-card:hover{box-shadow:0 8px 24px rgba(0,0,0,.06)}
    #news-page .news-thumb{width:180px;height:120px;object-fit:cover;border-radius:10px;flex:0 0 180px;background:#f3f4f6}
    #news-page .news-body{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px}
    #news-page .news-title{font-weight:800;font-size:18px;color:#111827}
    #news-page .news-meta{font-size:12px;color:#6b7280}
    #news-page .summary-wrap{position:relative;flex:1;min-height:64px}
    #news-page .news-summary{--lines:3;display:-webkit-box;-webkit-line-clamp:var(--lines);-webkit-box-orient:vertical;overflow:hidden;color:#374151;line-height:1.6;margin:0;padding-right:60px}
    #news-page .news-card[data-expanded="true"] .news-summary{-webkit-line-clamp:unset;overflow:visible}
    #news-page .more-toggle{position:absolute;bottom:0;right:0;border:none;background:linear-gradient(to right,rgba(255,255,255,0),#fff 40%);color:#2563eb;font-size:13px;padding:0 4px;cursor:pointer}
    #news-page .more-toggle:hover{text-decoration:underline}
    #news-page .pagination{display:flex;justify-content:center;align-items:center;gap:12px;margin-top:20px}
    #news-page .page-btn{border:1px solid #e5e7eb;border-radius:6px;padding:6px 12px;background:#fff;color:#111827;font-size:14px;text-decoration:none;transition:.15s}
    #news-page .page-btn:hover{background:#2563eb;color:#fff}
    #news-page .page-info{font-size:14px;color:#6b7280}
    @media (max-width:640px){#news-page .news-thumb{width:140px;height:100px}#news-page .news-title{font-size:16px}}

    /* ===== ì „ì¼ ë¸Œë¦¬í•‘: ë‰´ìŠ¤ ì¹´ë“œì²˜ëŸ¼ "ê°€ë¡œë¡œ ê¸´" ë‹¨ì¼ì—´ ë¦¬ìŠ¤íŠ¸ ===== */
    .news-section h3{margin:28px auto 14px;max-width:980px;font-weight:800;color:#1f3a69;letter-spacing:-.2px}
    .briefing-wrap{max-width:980px;margin:0 auto 28px}
    .briefing-date{margin:0 0 12px;font-size:13px;color:#6b7a91;padding-left:6px;border-left:3px solid #cfe2ff}
    .briefing-list{display:flex;flex-direction:column;gap:14px}

    /* ë¸Œë¦¬í•‘ ì¹´ë“œ = ë‰´ìŠ¤ ì¹´ë“œì™€ ë™ì¼í•œ í­/ì—¬ë°±ê° */
    .briefing-item{display:flex;gap:14px;align-items:flex-start;background:#fff;border:1px solid #e6eef8;border-radius:14px;padding:16px;box-shadow:0 6px 16px rgba(31,58,105,.06);transition:box-shadow .15s,transform .15s}
    .briefing-item:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(31,58,105,.08)}
    .briefing-bar{width:6px;align-self:stretch;border-radius:8px;background:#9cc0ff}
    .briefing-body{flex:1;min-width:0;display:flex;flex-direction:column;gap:8px}
    .briefing-title{display:flex;align-items:center;gap:8px;margin:0;font-weight:800;color:#16325c}
    .cat-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eef5ff;color:#1f4fb7;border:1px solid #d7e6ff;font-size:13px}
    .cat-chip .dot{width:8px;height:8px;border-radius:50%;background:#4c84ff;box-shadow:0 0 0 2px rgba(76,132,255,.15) inset}
    .briefing-summary{margin:0;color:#233549;line-height:1.7}
    .briefing-tags{display:flex;flex-wrap:wrap;gap:8px}
    .briefing-tags .tag{font-size:12px;color:#1f3a69;background:#f4f8ff;border:1px solid #dfe9ff;padding:6px 10px;border-radius:999px}

    /* ì¹´í…Œê³ ë¦¬ë³„ ë°”/ì¹© ìƒ‰ìƒ í†¤(ì„ íƒ) */
    /*.Cê¸ˆìœµ .briefing-bar{background:#6ea8fe}.Cë¶€ë™ì‚° .briefing-bar{background:#74c69d}*/
    /*.Cì‚°ì—… .briefing-bar{background:#f0ad4e}.Cê¸€ë¡œë²Œê²½ì œ .briefing-bar{background:#b197fc}*/
    /*.Cì¼ë°˜ .briefing-bar{background:#adb5bd}*/
    /*.Cë¶€ë™ì‚° .cat-chip{background:#eef9f3;color:#1b7a4a;border-color:#cfeadf}*/
    /*.Cì‚°ì—… .cat-chip{background:#fff6e8;color:#8a5b0a;border-color:#ffe2b8}*/
    /*.Cê¸€ë¡œë²Œê²½ì œ .cat-chip{background:#f3edff;color:#5b3fa6;border-color:#e2d5ff}*/
    /*.Cì¼ë°˜ .cat-chip{background:#f5f6f8;color:#485460;border-color:#e6e8ec}*/
    .briefing-item .briefing-bar { background:#6ea8fe; }
  </style>
</head>

<body>
<div th:replace="fragments/header :: siteHeader"></div>

<main class="main">
  <div class="container">
    <!-- ğŸ”§ FastAPI ì£¼ì†ŒëŠ” data-api-baseë¡œ ì§€ì • -->
    <div id="news-page" class="page" data-api-base="http://127.0.0.1:8005">
      <h2 class="page-title" style="text-align:center">ì˜¤ëŠ˜ì˜ ê²½ì œ ë‰´ìŠ¤</h2>

      <!-- ë‰´ìŠ¤ ë¦¬ìŠ¤íŠ¸ -->
      <div class="news-section">
        <h3>ê¸ˆì¼ ì£¼ìš” ë‰´ìŠ¤</h3>

        <div id="news-list" class="news-list">
          <div class="news-card" th:each="it : ${items}" th:attr="data-id=${it.id}" tabindex="0">
            <img class="news-thumb" th:src="${it.image} ?: @{/img/placeholder-120x80.png}" th:alt="${it.title}" />
            <div class="news-body">
              <span class="news-title" th:text="${it.title}">ì œëª©</span>
              <div class="news-meta" th:text="${it.publishedAt != null} ? ${#temporals.format(it.publishedAt, 'yyyy-MM-dd HH:mm')} : ''"></div>
              <div class="summary-wrap">
                <p class="news-summary" th:text="${it.summary}">ìš”ì•½</p>
                <button type="button" class="more-toggle">ë” ë³´ê¸°</button>
              </div>
            </div>
          </div>
          <p class="muted" th:if="${#lists.isEmpty(items)}">í‘œì‹œí•  ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>

        <div id="pagination" class="pagination">
          <a class="page-btn" th:if="${hasPrev}" th:href="@{/pages/news(page=${page - 1}, size=${size})}">ì´ì „</a>
          <span class="page-info" th:text="${page} + ' í˜ì´ì§€'">1 í˜ì´ì§€</span>
          <a class="page-btn" th:if="${hasNext}" th:href="@{/pages/news(page=${page + 1}, size=${size})}">ë‹¤ìŒ</a>
        </div>
      </div>

      <!-- ì „ì¼ ë¸Œë¦¬í•‘: ê°€ë¡œ ê¸´ ì¹´ë“œ ë‹¨ì¼ì—´ë¡œ ë‚˜ì—´ -->
      <div class="news-section">
        <h3>ì „ì¼ ë¸Œë¦¬í•‘ ìš”ì•½</h3>
        <div class="briefing-wrap">
          <p class="briefing-date">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>
          <div class="briefing-list" id="briefing-list">
            <!-- JSê°€ 5ê°œ ì¹´í…Œê³ ë¦¬ë¥¼ ìˆœì„œëŒ€ë¡œ ì‚½ì… -->
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- ìƒì„¸ ëª¨ë‹¬ (ê¸°ì¡´) -->
<div id="news-modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop"></div>
  <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <button type="button" class="modal-close" aria-label="ë‹«ê¸°">Ã—</button>
    <div class="modal-header">
      <h3 id="modal-title" class="modal-title"></h3>
      <div class="modal-meta"><span id="modal-updated" class="meta-date"></span></div>
    </div>
    <div class="modal-body">
      <img id="modal-image" class="modal-image" alt="article image" style="display:none;" />
      <div class="modal-content"><p id="modal-content"></p></div>
    </div>
    <div class="modal-footer">
      <a id="modal-link" class="btn" href="#" target="_blank" rel="noopener noreferrer">ì›ë¬¸ ë§í¬</a>
      <span id="modal-press" class="meta-press"></span>
    </div>
  </div>
</div>

<div th:replace="fragments/footer :: siteFooter"></div>

<script th:src="@{/js/app.js}" defer></script>

<script>
  /* ====================== ë‰´ìŠ¤ ì¹´ë“œ UX ====================== */
  (function(){
    const list = document.getElementById('news-list');

    // ë”ë³´ê¸°/ì ‘ê¸°
    list.addEventListener('click', (e)=>{
      const btn = e.target.closest('.more-toggle'); if(!btn) return;
      e.stopPropagation(); e.preventDefault();
      const card = btn.closest('.news-card');
      const expanded = card.getAttribute('data-expanded') === 'true';
      card.setAttribute('data-expanded', expanded ? 'false' : 'true');
      btn.textContent = expanded ? 'ë” ë³´ê¸°' : 'ì ‘ê¸°';
    });

    // ìš”ì•½ ì§§ìœ¼ë©´ ë”ë³´ê¸° ìˆ¨ê¹€
    function applyMoreToggleVisibility(){
      document.querySelectorAll('#news-list .news-card').forEach(card=>{
        const p = card.querySelector('.news-summary');
        const btn = card.querySelector('.more-toggle');
        if(!p || !btn) return;
        const needsMore = p.scrollHeight > p.clientHeight + 1;
        btn.style.display = needsMore ? 'inline' : 'none';
      });
    }
    window.addEventListener('load', applyMoreToggleVisibility);
    window.addEventListener('resize', ()=>{ clearTimeout(window.__moreTo); window.__moreTo=setTimeout(applyMoreToggleVisibility,120); });

    // ì¹´ë“œ í´ë¦­ â†’ ëª¨ë‹¬
    const modal = document.getElementById('news-modal');
    const closeBtn = modal.querySelector('.modal-close');
    const backdrop = modal.querySelector('.modal-backdrop');
    const $mTitle=document.getElementById('modal-title');
    const $mUpdated=document.getElementById('modal-updated');
    const $mImg=document.getElementById('modal-image');
    const $mContent=document.getElementById('modal-content');
    const $mLink=document.getElementById('modal-link');
    const $mPress=document.getElementById('modal-press');

    const lockScroll = (lock)=>{ document.documentElement.style.overflow=document.body.style.overflow=lock?'hidden':''; };
    const showModal = ()=>{ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); lockScroll(true); };
    const hideModal = ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); lockScroll(false); };
    closeBtn.addEventListener('click', hideModal); backdrop.addEventListener('click', hideModal);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hideModal(); });

    async function openModalById(id){
      try{
        const res = await fetch(`/pages/news/${encodeURIComponent(id)}`);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        $mTitle.textContent = data.title || '(ì œëª© ì—†ìŒ)';
        const updated = data.updated_at || data.publishedAt || data.published_at;
        $mUpdated.textContent = updated ? String(updated).substring(0,10) : '';
        if(data.image){ $mImg.src=data.image; $mImg.alt=data.title||'image'; $mImg.style.display='block'; $mImg.onerror=()=>{$mImg.style.display='none';}; }
        else { $mImg.removeAttribute('src'); $mImg.style.display='none'; }
        $mContent.textContent = data.content || data.summary || '';
        if(data.url){ $mLink.href=data.url; $mLink.style.display='inline-block'; } else { $mLink.removeAttribute('href'); $mLink.style.display='none'; }
        $mPress.textContent = data.press ? ('ì¶œì²˜: '+data.press) : '';
        showModal();
      }catch(e){ console.error(e); alert('ìƒì„¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); }
    }
    list.addEventListener('click', (e)=>{ if(e.target.closest('.more-toggle')) return; const card=e.target.closest('.news-card'); if(!card) return; const id=card.getAttribute('data-id'); if(id) openModalById(id); });
    list.addEventListener('keydown', (e)=>{ if(e.key!=='Enter') return; const card=e.target.closest('.news-card'); if(!card) return; const id=card.getAttribute('data-id'); if(id) openModalById(id); });
  })();

  /* ====================== ì „ì¼ ë¸Œë¦¬í•‘: 5ê°œ ì¹´í…Œê³ ë¦¬, ê°€ë¡œ ê¸´ ì¹´ë“œë¡œ ì„¸ë¡œ ë‚˜ì—´ ====================== */
  (function(){
    const API_BASE = document.getElementById('news-page')?.dataset?.apiBase || '';
    const dateEl = document.querySelector('.briefing-date');
    const listEl = document.getElementById('briefing-list');

    const ORDER = ['ê¸ˆìœµ','ë¶€ë™ì‚°','ì‚°ì—…','ê¸€ë¡œë²Œê²½ì œ','ì¼ë°˜'];

    function mapCategory(name){
      if(!name) return 'ì¼ë°˜';
      if(name === 'ì¦ê¶Œ') return 'ê¸ˆìœµ'; // â˜… ì¦ê¶Œ â†’ ê¸ˆìœµ ë³‘í•©
      return name;
    }

    function normalizeCategories(arr){
      const byCat = new Map();
      (arr||[]).forEach(src=>{
        const cat = mapCategory(src.category || 'ì¼ë°˜');
        if(!byCat.has(cat)) byCat.set(cat, { category:cat, summary:'', highlights:[] });
        const dst = byCat.get(cat);
        const s = (src.summary||'').trim();
        if(s && !dst.summary.includes(s)) dst.summary = (dst.summary ? dst.summary+' ' : '') + s;
        const hs = Array.isArray(src.highlights) ? src.highlights : [];
        const set = new Set(dst.highlights.concat(hs));
        dst.highlights = Array.from(set).slice(0,12);
      });
      const out = [];
      ORDER.forEach(cat=>{
        if(byCat.has(cat)) out.push(byCat.get(cat));
        else out.push({ category:cat, summary:'í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì „ì¼ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.', highlights:[] });
      });
      return out;
    }

    function makeItem(cat){
      const wrap = document.createElement('div');
      wrap.className = `briefing-item C${cat.category}`;
      const bar = document.createElement('div'); bar.className='briefing-bar';
      const body = document.createElement('div'); body.className='briefing-body';

      const h = document.createElement('h5'); h.className='briefing-title';
      const chip = document.createElement('span'); chip.className='cat-chip';
      const dot = document.createElement('span'); dot.className='dot';
      const lbl = document.createElement('span'); lbl.textContent = cat.category;
      chip.append(dot,lbl); h.append(chip);

      const p = document.createElement('p'); p.className='briefing-summary'; p.textContent = cat.summary || 'ìš”ì•½ ì—†ìŒ';

      const tags = document.createElement('div'); tags.className='briefing-tags';
      (cat.highlights || []).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; tags.appendChild(s); });

      body.append(h,p,tags);
      wrap.append(bar,body);
      return wrap;
    }

    async function load(){
      try{
        dateEl.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
        listEl.innerHTML = '';
        const res = await fetch(`${API_BASE}/briefing/yesterday`, { headers:{'Accept':'application/json'} });
        if(!res.ok){ dateEl.textContent = 'ì „ì¼ ê¸°ì‚¬ ìš”ì•½ì´ ì—†ìŠµë‹ˆë‹¤.'; return; }
        const raw = await res.json();
        const cats = normalizeCategories(raw?.categories || []);
        dateEl.textContent = (raw?.date ? `(${raw.date}) ` : '') + 'ì „ì¼ ì¹´í…Œê³ ë¦¬ë³„ ìš”ì•½';
        cats.forEach(c => listEl.appendChild(makeItem(c)));
      }catch(e){
        console.warn(e);
        dateEl.textContent = 'ìš”ì•½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
      }
    }

    load();
  })();
</script>

<noscript>ì´ í˜ì´ì§€ë¥¼ ë³´ë ¤ë©´ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¥¼ í™œì„±í™”í•˜ì„¸ìš”.</noscript>
</body>
</html>
