<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>오늘의 경제 뉴스</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" th:href="@{/css/style.css}" />

  <!-- ▼▼▼ 수정된 부분 포함 CSS ▼▼▼ -->
  <style>
    /* ===== 스코프: 이 페이지 안에서만 동작 ===== */
    #news-page .news-list{
      max-width: 980px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #news-page .news-card{
      border:1px solid #e5e7eb; border-radius:14px; background:#fff;
      padding:16px;
      display:flex; gap:16px; align-items:flex-start;
      transition:box-shadow .18s;
    }
    #news-page .news-card:hover{ box-shadow:0 8px 24px rgba(0,0,0,.06); }

    #news-page .news-thumb{
      width: 180px; height: 120px; object-fit:cover; border-radius:10px; flex:0 0 180px;
      background:#f3f4f6;
    }

    #news-page .news-body{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    #news-page .news-title{ font-weight:800; font-size:18px; color:#111827; }
    #news-page .news-meta{ font-size:12px; color:#6b7280; }

    /* ✅ 요약 박스 수정 */
    #news-page .summary-wrap{
      position: relative;
      flex: 1;
      min-height: 64px;
    }

    #news-page .news-summary{
      --lines: 3;
      display: -webkit-box;
      -webkit-line-clamp: var(--lines);
      -webkit-box-orient: vertical;
      overflow: hidden;
      color:#374151;
      line-height:1.6;
      margin:0;
      padding-right:60px; /* 버튼 공간 확보 */
      position:relative;
    }

    #news-page .news-card[data-expanded="true"] .news-summary{
      -webkit-line-clamp: unset;
      overflow: visible;
      /* ✅ padding-right 유지 → 폭 동일 */
      padding-right:60px;
    }

    /* ✅ 버튼을 문단 오른쪽 아래로 고정 */
    #news-page .more-toggle{
      position:absolute;
      bottom:0;
      right:0;
      border:none;
      background:linear-gradient(to right, rgba(255,255,255,0), #fff 40%);
      color:#2563eb;
      font-size:13px;
      padding:0 4px;
      cursor:pointer;
      line-height:1.6;
    }
    #news-page .more-toggle:hover{ text-decoration:underline; }

    #news-page .pagination {
      display: flex;
      justify-content: center;   /* 가로 가운데 정렬 */
      align-items: center;       /* 세로 가운데 맞춤 */
      gap: 12px;                 /* 버튼 간격 */
      margin-top: 20px;
      text-align: center;
    }

    #news-page .page-btn {
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 6px 12px;
      background: #fff;
      color: #111827;
      font-size: 14px;
      text-decoration: none;
      transition: all 0.15s ease;
    }

    #news-page .page-btn:hover {
      background: #2563eb;
      color: #fff;
    }

    #news-page .page-info {
      font-size: 14px;
      color: #6b7280;
    }

    /* 반응형 */
    @media (max-width:640px){
      #news-page .news-thumb{ width:140px; height:100px; flex-basis:140px; }
      #news-page .news-title{ font-size:16px; }
    }
  </style>
</head>

<body>
<div th:replace="fragments/header :: siteHeader"></div>

<main class="main">
  <div class="container">
    <div id="news-page" class="page">
      <h2 class="page-title" style="text-align:center">오늘의 경제 뉴스</h2>

      <div class="news-section">
        <h3>금일 주요 뉴스</h3>

        <div id="news-list" class="news-list">
          <div class="news-card"
               th:each="it : ${items}"
               th:attr="data-id=${it.id}"
               tabindex="0">

            <img class="news-thumb"
                 th:src="${it.image} ?: @{/img/placeholder-120x80.png}"
                 th:alt="${it.title}" />

            <div class="news-body">
              <span class="news-title" th:text="${it.title}">제목</span>
              <div class="news-meta"
                   th:text="${it.publishedAt != null} ? ${#temporals.format(it.publishedAt, 'yyyy-MM-dd HH:mm')} : ''">
              </div>

              <!-- ✅ 수정된 부분 -->
              <div class="summary-wrap">
                <p class="news-summary" th:text="${it.summary}">요약</p>
                <button type="button" class="more-toggle">더 보기</button>
              </div>
            </div>
          </div>

          <p class="muted" th:if="${#lists.isEmpty(items)}">표시할 뉴스가 없습니다.</p>
        </div>

        <div id="pagination" class="pagination">
          <a class="page-btn"
             th:if="${hasPrev}"
             th:href="@{/pages/news(page=${page - 1}, size=${size})}">이전</a>
          <span class="page-info" th:text="${page} + ' 페이지'">1 페이지</span>
          <a class="page-btn"
             th:if="${hasNext}"
             th:href="@{/pages/news(page=${page + 1}, size=${size})}">다음</a>
        </div>
      </div>

      <div class="news-section">
        <h3>전일 브리핑 요약</h3>
        <div class="briefing-card border rounded p-3 mt-4">
          <div class="briefing-content">
            <p>불러오는 중…</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- 상세 모달 -->
<div id="news-modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop"></div>
  <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <button type="button" class="modal-close" aria-label="닫기">×</button>
    <div class="modal-header">
      <h3 id="modal-title" class="modal-title"></h3>
      <div class="modal-meta">
        <span id="modal-updated" class="meta-date"></span>
      </div>
    </div>
    <div class="modal-body">
      <img id="modal-image" class="modal-image" alt="article image" style="display:none;" />
      <div class="modal-content">
        <p id="modal-content"></p>
      </div>
    </div>
    <div class="modal-footer">
      <a id="modal-link" class="btn" href="#" target="_blank" rel="noopener noreferrer">원문 링크</a>
      <span id="modal-press" class="meta-press"></span>
    </div>
  </div>
</div>

<script th:src="@{/js/app.js}" defer></script>

<script>
  (function () {
    const modal = document.getElementById('news-modal');
    const closeBtn = modal.querySelector('.modal-close');
    const backdrop = modal.querySelector('.modal-backdrop');
    const $mTitle   = document.getElementById('modal-title');
    const $mUpdated = document.getElementById('modal-updated');
    const $mImg     = document.getElementById('modal-image');
    const $mContent = document.getElementById('modal-content');
    const $mLink    = document.getElementById('modal-link');
    const $mPress   = document.getElementById('modal-press');

    function lockScroll(lock){ document.documentElement.style.overflow = document.body.style.overflow = lock ? 'hidden' : ''; }
    function showModal(){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); lockScroll(true); }
    function hideModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); lockScroll(false); }

    closeBtn.addEventListener('click', hideModal);
    backdrop.addEventListener('click', hideModal);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hideModal(); });

    async function openModalById(id){
      try{
        const res = await fetch(`/pages/news/${encodeURIComponent(id)}`);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();

        $mTitle.textContent = data.title || '(제목 없음)';
        const updated = data.updated_at || data.publishedAt || data.published_at;
        $mUpdated.textContent = updated ? String(updated).substring(0,10) : '';

        if(data.image){
          $mImg.src = data.image;
          $mImg.alt = data.title || 'article image';
          $mImg.style.display = 'block';
          $mImg.onerror = () => { $mImg.style.display = 'none'; };
        } else {
          $mImg.removeAttribute('src');
          $mImg.style.display = 'none';
        }

        $mContent.textContent = data.content || data.summary || '';
        if(data.url){ $mLink.href = data.url; $mLink.style.display = 'inline-block'; }
        else { $mLink.removeAttribute('href'); $mLink.style.display = 'none'; }

        $mPress.textContent = data.press ? ('출처: ' + data.press) : '';
        showModal();
      }catch(e){
        console.error(e);
        alert('상세를 불러오지 못했습니다.');
      }
    }

    const list = document.getElementById('news-list');
    list.addEventListener('click', (e)=>{
      const btn = e.target.closest('.more-toggle');
      if (btn) return;
      const card = e.target.closest('.news-card');
      if(!card) return;
      const id = card.getAttribute('data-id');
      if(id) openModalById(id);
    });

    list.addEventListener('keydown', (e)=>{
      if(e.key!=='Enter') return;
      const card = e.target.closest('.news-card');
      if(!card) return;
      const id = card.getAttribute('data-id');
      if(id) openModalById(id);
    });

    list.addEventListener('click', (e)=>{
      const btn = e.target.closest('.more-toggle');
      if (!btn) return;
      e.stopPropagation();
      e.preventDefault();

      const card = btn.closest('.news-card');
      const expanded = card.getAttribute('data-expanded') === 'true';
      card.setAttribute('data-expanded', expanded ? 'false' : 'true');
      btn.textContent = expanded ? '더 보기' : '접기';
    });

    (async function loadBriefing(){
      const wrap = document.querySelector('.briefing-content');
      if(!wrap) return;
      try{
        const res = await fetch('/pages/news/api/briefing/yesterday');
        if(!res.ok){ wrap.innerHTML = '<p class="muted">전일 기사 요약이 없습니다.</p>'; return; }
        const data = await res.json();
        wrap.innerHTML = '';

        const date = document.createElement('p');
        date.className = 'briefing-date';
        date.textContent = (data.date ? '('+data.date+') ' : '') + '전일 카테고리별 요약';
        wrap.appendChild(date);

        if(!Array.isArray(data.categories) || data.categories.length===0){
          wrap.innerHTML += '<p class="muted">전일 기사 요약이 없습니다.</p>';
          return;
        }

        for(const cat of data.categories){
          const box = document.createElement('div');
          box.className = 'briefing-box';
          const h5 = document.createElement('h5'); h5.className = 'briefing-title'; h5.textContent = '📌 ' + (cat.category || '분류 없음');
          const p = document.createElement('p');  p.className  = 'briefing-summary'; p.textContent = cat.summary || '요약 없음';
          const tags = document.createElement('div'); tags.className = 'briefing-highlights';

          if(Array.isArray(cat.highlights)){
            for(const t of cat.highlights){
              const span = document.createElement('span');
              span.className = 'highlight';
              span.textContent = t;
              tags.appendChild(span);
            }
          }
          box.append(h5,p,tags);
          wrap.appendChild(box);
        }
      }catch(_){
        const w = document.querySelector('.briefing-content');
        if (w) w.innerHTML = '<p class="error">요약 데이터를 불러오지 못했습니다.</p>';
      }
    })();
  })();
</script>

<noscript>이 페이지를 보려면 자바스크립트를 활성화하세요.</noscript>
</body>
</html>
