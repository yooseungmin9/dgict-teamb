<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>EcoNews AI - 감성 분석</title>
  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <script th:src="@{/js/app.js}" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .analysis-grid { display: flex; gap: 32px; }
    .chart-container { flex: 2; }
    .sentiment-summary { flex: 1; padding: 16px; border: 1px solid #ddd; border-radius: 8px; }
    .sentiment-item { margin: 8px 0; font-size: 16px; }
    .positive { color: #36a2eb; }
    .neutral { color: #999; }
    .negative { color: #ff6384; }

    .category-cards { display: flex; gap: 16px; margin-top: 32px; overflow-x: auto; padding-bottom: 8px; }
    .category-card { min-width: 200px; flex: 0 0 auto; border: 1px solid #eee; border-radius: 12px; padding: 16px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); text-align: center; }
    .category-card h4 { margin-bottom: 8px; font-size: 18px; font-weight: 600; color: #2c3e50; }
    .category-card .status { font-weight: 600; margin-bottom: 6px; }
    .status.positive { color: #36a2eb; }
    .status.neutral { color: #666; }
    .status.negative { color: #ff6384; }
  </style>
</head>
<body>
<div th:replace="~{fragments/header :: siteHeader}"></div>

<main class="main">
  <div class="container">
    <div id="sentiment" class="page">
      <h2 class="page-title">경제 뉴스 감성 분석</h2>
      <div class="analysis-grid">
        <div class="chart-container">
          <canvas id="pyramidChart" width="400" height="250"></canvas>
        </div>
        <div class="sentiment-summary">
          <h3>오늘의 시장 감성</h3>
          <div class="sentiment-item positive">
            <span class="sentiment-label">긍정</span>
            <span id="positiveValue">0%</span>
          </div>
          <div class="sentiment-item neutral">
            <span class="sentiment-label">중립</span>
            <span id="neutralValue">0%</span>
          </div>
          <div class="sentiment-item negative">
            <span class="sentiment-label">부정</span>
            <span id="negativeValue">0%</span>
          </div>
        </div>
      </div>

      <!-- ✅ 업종별 감성 요약 카드 -->
      <section style="margin-top:40px;">
        <h3>업종별 감성 요약</h3>
        <div class="category-cards" id="categoryCards"></div>
      </section>
    </div>
  </div>
</main>

<script>
  async function loadData() {
    // ✅ 같은 출처(8081) 프록시 경로 호출
    const res = await fetch("/api/sentiment?days=7");
    const json = await res.json();
    const data = json.data;

    const categories = Object.keys(data);
    const pos = categories.map(c => data[c]["긍정"] || 0);
    const neu = categories.map(c => data[c]["중립"] || 0);
    const neg = categories.map(c => -(data[c]["부정"] || 0));

    const totalPos = pos.reduce((a,b)=>a+b,0);
    const totalNeu = neu.reduce((a,b)=>a+b,0);
    const totalNeg = -neg.reduce((a,b)=>a+b,0);
    const total = totalPos + totalNeu + totalNeg;

    document.getElementById("positiveValue").textContent = ((totalPos/total)*100).toFixed(1)+"%";
    document.getElementById("neutralValue").textContent = ((totalNeu/total)*100).toFixed(1)+"%";
    document.getElementById("negativeValue").textContent = ((totalNeg/total)*100).toFixed(1)+"%";

    const maxVal = Math.max(...pos, ...neg.map(v=>-v));
    const ctx = document.getElementById("pyramidChart").getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: categories,
        datasets: [
          { label: "부정", data: neg, backgroundColor: "rgba(255,99,132,0.7)" },
          { label: "긍정", data: pos, backgroundColor: "rgba(54,162,235,0.7)" }
        ]
      },
      options: {
        indexAxis: "y",
        responsive: true,
        scales: {
          x: {
            stacked: true,
            suggestedMin: -maxVal,
            suggestedMax: maxVal,
            ticks: { callback: v => Math.abs(v) }
          },
          y: { stacked: true }
        },
        plugins: {
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${Math.abs(ctx.raw)}` } },
          legend: { position: "top" }
        }
      }
    });

    renderCategoryCards(data);
  }

  function renderCategoryCards(data) {
    const container = document.getElementById("categoryCards");
    container.innerHTML = "";

    Object.entries(data).forEach(([category, values]) => {
      const pos = values["긍정"] || 0;
      const neu = values["중립"] || 0;
      const neg = values["부정"] || 0;

      let status = "보합 ➡", statusClass = "neutral";
      if (pos > neg && pos > neu) { status = "상승 ⬆"; statusClass = "positive"; }
      else if (neg > pos && neg > neu) { status = "둔화 ⬇"; statusClass = "negative"; }

      const card = `
        <div class="category-card">
          <h4>${category}</h4>
          <div class="status ${statusClass}">${status}</div>
          <p>긍정 ${pos}, 중립 ${neu}, 부정 ${neg}</p>
        </div>
      `;
      container.insertAdjacentHTML("beforeend", card);
    });
  }

  loadData();
</script>
</body>
</html>
