<header class="appbar" th:fragment="siteHeader" xmlns:th="http://www.w3.org/1999/xhtml">
  <!-- ì¢Œì¸¡: ë¡œê³  -->
  <a class="appbar__logo" data-url="/pages/" aria-label="ëŒ€ì‹œë³´ë“œë¡œ ì´ë™">
    <svg viewBox="0 0 24 24" class="brand__logo" aria-hidden="true">
      <path d="M3 12h3l3 7 4-14 3 7h5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <span class="appbar__brand">SUMMARIX</span>
  </a>

  <!-- ì¤‘ì•™: íƒ­ ë‚´ë¹„ê²Œì´ì…˜ -->
  <nav class="appbar__tabs" aria-label="ì£¼ ë©”ë‰´">
    <button class="tab-btn" data-url="/pages/news">ë‰´ìŠ¤ ìš”ì•½</button>
    <button class="tab-btn" data-url="/pages/youtube_opinion">ìœ íŠœë¸Œ ë¶„ì„</button>
    <button class="tab-btn" data-url="/pages/chat">ì±—ë´‡</button>
    <button class="tab-btn" data-url="/pages/recommend">ì¶”ì²œ</button>
  </nav>

  <!-- ìš°ì¸¡: ê²€ìƒ‰ + ê³„ì • -->
  <div class="appbar__actions">
    <div class="searchbox" role="search">
      <input class="search__input" type="text" id="q" placeholder="ê²€ìƒ‰" aria-label="ê²€ìƒ‰ì–´ ì…ë ¥" />
      <button class="search__btn" type="button" id="searchBtn" aria-label="ê²€ìƒ‰ ì‹¤í–‰">
        <svg viewBox="0 0 24 24" class="icon" aria-hidden="true" width="18" height="18">
          <circle cx="11" cy="11" r="7" fill="none" stroke="currentColor" stroke-width="2"/>
          <path d="M16.5 16.5L21 21" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
      </button>
    </div>

    <!-- ë¡œê·¸ì¸ ìƒíƒœ -->
    <div th:if="${session.loginUser != null}">
      <button id="accountBtn" class="account-btn" type="button" title="ê³„ì •ì •ë³´">
        <svg viewBox="0 0 24 24" class="account-icon" aria-hidden="true">
          <path fill="#fff" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"/>
        </svg>
      </button>
    </div>
    <div th:if="${session.loginUser != null}">
      <form th:action="@{/auth/logout}" method="post">
        <button id="logoutBtn" class="logout-btn" type="submit" title="ë¡œê·¸ì•„ì›ƒ">Logout</button>
      </form>
    </div>

    <!-- ë¹„ë¡œê·¸ì¸ ìƒíƒœ -->
    <div th:if="${session.loginUser == null}">
      <button id="loginBtn" class="login-btn" title="ë¡œê·¸ì¸" data-url="/auth/login">Login</button>
    </div>
  </div>

  <!-- ì ‘ê·¼ì„±/ë¼ìš°íŒ… + ê³„ì • ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    (function () {
      // data-url ì´ë™ ì²˜ë¦¬
      function go(el){ var u=el.dataset.url; if(u) window.location.href=u; }
      function onClick(e){ go(e.currentTarget); }
      function onKey(e){ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); go(e.currentTarget);} }
      document.querySelectorAll('[data-url]').forEach(function(el){
        el.addEventListener('click', onClick);
        el.addEventListener('keydown', onKey);
        el.style.cursor='pointer';
      });

      // í˜„ì¬ íƒ­ í™œì„±í™”
      var path = location.pathname;
      document.querySelectorAll('.appbar__tabs .tab-btn').forEach(function(b){
        if(path.startsWith(b.dataset.url)) b.classList.add('active');
      });

      // ğŸ”¹ ê³„ì • ëª¨ë‹¬ (app.jsì—ì„œ ì´ë™)
      document.addEventListener('DOMContentLoaded', function(){
        const trigger = document.getElementById('accountBtn');
        if(!trigger) return;

        let backdrop, dialog, closeBtn;
        const K = { zBackdrop:99998, zDialog:99999, animMs:160 };

        function build(){
          if(backdrop && dialog) return;
          backdrop = document.createElement('div');
          backdrop.id = 'accountPortalBackdrop';
          backdrop.style.cssText = `
            position:fixed; inset:0; background:rgba(0,0,0,.45);
            z-index:${K.zBackdrop}; opacity:0; transition:opacity 160ms ease;`;
          dialog = document.createElement('div');
          dialog.id = 'accountPortalDialog';
          dialog.style.cssText = `
            position:fixed; left:50%; top:50%; transform:translate(-50%,-48%);
            z-index:99999;

            /* â¬‡ï¸ í¬ê¸° ì‚´ì§ ì¤„ì´ê³ , ì—¬ë°± ì—¬ìœ  ìˆê²Œ */
            width:min(740px, 92vw);
            max-height:min(72vh, 1000px);

            /* â¬‡ï¸ í†¤ ë‹¤ìš´: ë” ì˜…ì€ ë³´ë” + ë¶€ë“œëŸ¬ìš´ ë¼ìš´ë“œ + ì€ì€í•œ ê·¸ë¦¼ì */
            background:#fff;
            border:1px solid rgba(0,0,0,.06);
            border-radius:14px;
            box-shadow:0 12px 24px rgba(0,0,0,.18);

            overflow:hidden; display:flex; flex-direction:column; opacity:0;
            transition:opacity 160ms ease, transform 160ms ease;
          `;

// iframe ë†’ì´ë„ ìœ„ max-heightì™€ ë§ì¶°ì„œ
          dialog.innerHTML = `
            <div style="display:flex;align-items:center;justify-content:space-between;
                        padding:12px 16px;border-bottom:1px solid rgba(0,0,0,.06)">
              <h2 style="margin:0;font-size:16px;font-weight:700;color:#0f172a">ê³„ì • ì •ë³´</h2>
              <button id="accountPortalClose" aria-label="ë‹«ê¸°"
                      style="border:1px solid rgba(15,23,42,.08);background:#fff;cursor:pointer;
                             font-size:16px;line-height:1;padding:6px 8px;border-radius:8px">âœ•</button>
            </div>
            <div style="padding:0;height:100%">
              <iframe src="/member/account" title="ê³„ì • ì •ë³´"
                      style="display:block;width:100%;
                             height:calc(min(88vh,1000px) - 49px); border:0"></iframe>
            </div>
          `;
          document.body.append(backdrop, dialog);
          closeBtn = dialog.querySelector('#accountPortalClose');
          backdrop.addEventListener('click', close);
          closeBtn.addEventListener('click', close);
          document.addEventListener('keydown', onKey);
        }

        function open(e){
          e.preventDefault();
          build();
          document.documentElement.style.overflow = 'hidden';
          requestAnimationFrame(()=>{
            backdrop.style.opacity='1';
            dialog.style.opacity='1';
            dialog.style.transform='translate(-50%,-50%)';
          });
          trigger.setAttribute('aria-expanded','true');
          closeBtn.focus();
        }

        function close(){
          if(!dialog||!backdrop) return;
          dialog.style.opacity='0';
          dialog.style.transform='translate(-50%,-48%)';
          backdrop.style.opacity='0';
          setTimeout(()=>{
            backdrop.remove(); dialog.remove();
            backdrop = dialog = closeBtn = null;
            document.documentElement.style.overflow='';
            trigger.setAttribute('aria-expanded','false');
            trigger.focus();
          }, K.animMs);
        }

        function onKey(ev){ if(ev.key==='Escape') close(); }

        trigger.addEventListener('click', open);
      });
    })();
  </script>
</header>
