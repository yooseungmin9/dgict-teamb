<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>RAG 뉴스 챗봇</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { color-scheme: light dark; }
        html, body { scroll-behavior: smooth; }
        .bubble { max-width: 80%; }
        .dot { animation: blink 1.4s infinite both }
        .dot:nth-child(2){ animation-delay:.2s }
        .dot:nth-child(3){ animation-delay:.4s }
        @keyframes blink{ 0%,80%,100%{opacity:0} 40%{opacity:1} }
        .scroll-thin::-webkit-scrollbar{ width:10px }
        .scroll-thin::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:8px }
        @media (prefers-color-scheme: dark){
            .scroll-thin::-webkit-scrollbar-thumb{ background:#475569 }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950 text-slate-900 dark:text-slate-100 min-h-screen">

<header class="sticky top-0 z-10 backdrop-blur bg-white/60 dark:bg-slate-900/60 border-b border-slate-200/60 dark:border-slate-800">
    <div class="mx-auto max-w-4xl px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-2xl bg-blue-600 flex items-center justify-center shadow text-white">AI</div>
            <div>
                <h1 class="text-lg font-semibold">RAG 뉴스 챗봇</h1>
                <p class="text-xs text-slate-500 dark:text-slate-400">GPT-5 · 문서 기반 + 서버 수집 데이터</p>
            </div>
        </div>
        <button id="resetBtn" class="px-3 py-2 rounded-xl text-sm bg-slate-200 hover:bg-slate-300 dark:bg-slate-800 dark:hover:bg-slate-700 transition">
            대화 초기화
        </button>
    </div>
</header>

<main class="mx-auto max-w-4xl px-4 py-6">
    <section class="mb-4">
        <div class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/60 p-4 shadow-sm">
            <p class="text-sm leading-relaxed text-slate-600 dark:text-slate-300">
                ⓘ 이 챗봇은 <b>RAG기술을 사용하여</b> 실시간 정보를 수집하여 답변합니다. 실시간/Top N 뉴스는 서버에서 수집·요약 후 안내합니다.
                <br> 질의예) "이 사이트에서 제공하는 기능은 뭐야?", "오늘 가장 조회수 많은 뉴스 Top5 알려줘" </br>
            </p>
        </div>
    </section>

    <section class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/60 shadow-sm">
        <div id="chat" class="h-[60vh] p-4 overflow-y-auto scroll-thin">
            <div class="flex items-start gap-3 mb-4">
                <div class="shrink-0 w-9 h-9 rounded-2xl bg-blue-600 text-white flex items-center justify-center">AI</div>
                <div class="bubble rounded-2xl px-4 py-3 bg-slate-100 dark:bg-slate-800">
                    <p class="text-sm leading-relaxed">
                        안녕하세요! 인공지능 상담사입니다. 무엇이 궁금하신가요?
                    </p>
                </div>
            </div>
        </div>

        <div class="p-3 border-t border-slate-200 dark:border-slate-800">
            <form id="chatForm" class="flex items-end gap-2">
        <textarea id="messageInput" rows="1" placeholder="메시지를 입력하고 Enter…"
                  class="flex-1 resize-none rounded-2xl px-4 py-3 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                <button id="sendBtn" type="submit"
                        class="px-4 py-3 rounded-2xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium shadow transition disabled:opacity-60 disabled:cursor-not-allowed">
                    보내기
                </button>
            </form>
        </div>
    </section>
</main>


<script>
    // ================== 서버와 연결할 기본 설정 ==================
    const CHAT_URL = "/api/chat";   // 서버에 메시지를 보낼 주소
    const RESET_URL = "/api/reset"; // 대화 기록을 초기화할 주소
    const TIMEOUT_MS = 180000;      // 3분(180초)이 지나면 요청을 강제로 취소

    // ================== 화면 요소 찾기 ==================
    const chatEl   = document.getElementById("chat");          // 대화창(말풍선들이 쌓임)
    const formEl   = document.getElementById("chatForm");      // 입력 폼
    const inputEl  = document.getElementById("messageInput");  // 내가 입력하는 칸
    const sendBtn  = document.getElementById("sendBtn");       // 보내기 버튼
    const resetBtn = document.getElementById("resetBtn");      // 대화 초기화 버튼

    // ================== 보조 기능 함수 ==================
    // 특수문자를 HTML 안전하게 바꿔주는 함수(XSS 공격 방지)
    const escapeHtml = (s)=>s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));

    // 입력창 크기를 자동으로 늘려주는 함수(줄이 길어지면 높이 자동 증가)
    const autoGrow = (ta)=>{ 
        ta.style.height='auto'; 
        ta.style.height=ta.scrollHeight+'px'; 
    };

    // 채팅창을 항상 맨 아래로 스크롤시키는 함수
    const scrollToBottom = ()=>{ chatEl.scrollTop = chatEl.scrollHeight; };

    // ================== 채팅 말풍선 만들기 ==================
    // 내가 보낸 메시지를 화면에 표시
    function bubbleUser(text){
        chatEl.insertAdjacentHTML("beforeend",
            `<div class="flex items-start gap-3 mb-4 justify-end">
                <div class="bubble rounded-2xl px-4 py-3 bg-blue-600 text-white shadow">${escapeHtml(text)}</div>
                <div class="shrink-0 w-9 h-9 rounded-2xl bg-blue-100 dark:bg-slate-800 flex items-center justify-center text-blue-700 dark:text-slate-200">나</div>
            </div>`);
        scrollToBottom();
    }

    // AI가 보낸 메시지를 화면에 표시
    function bubbleAI(html){
        chatEl.insertAdjacentHTML("beforeend",
            `<div class="flex items-start gap-3 mb-4">
                <div class="shrink-0 w-9 h-9 rounded-2xl bg-blue-600 text-white flex items-center justify-center">AI</div>
                <div class="bubble rounded-2xl px-4 py-3 bg-slate-100 dark:bg-slate-800 shadow">
                    <div class="prose prose-slate dark:prose-invert max-w-none text-sm">${html}</div>
                </div>
            </div>`);
        scrollToBottom();
    }

    // AI가 "입력 중..." 표시(세 개의 점이 깜빡이는 효과)
    function bubbleTyping(){
        const id = "typing-" + (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
        chatEl.insertAdjacentHTML("beforeend",
            `<div id="${id}" class="flex items-start gap-3 mb-4">
                <div class="shrink-0 w-9 h-9 rounded-2xl bg-blue-600 text-white flex items-center justify-center">AI</div>
                <div class="bubble rounded-2xl px-4 py-3 bg-slate-100 dark:bg-slate-800">
                    <span class="inline-flex items-center gap-1 text-slate-500">
                        <span class="dot">●</span><span class="dot">●</span><span class="dot">●</span>
                    </span>
                </div>
            </div>`);
        scrollToBottom();
        return id; // 나중에 지우기 위해 id를 반환
    }

    // 특정 id의 HTML 요소 지우기 (예: "입력 중..." 메시지 제거)
    function removeEl(id){ 
        const el=document.getElementById(id); 
        if(el) el.remove(); 
    }

    // 간단한 마크다운 → HTML 변환 (줄바꿈, 리스트 표시)
    function mdSafe(text){ 
        return escapeHtml(text).replace(/^-\s/gm,"• ").replace(/\n/g,"<br>"); 
    }

    // ================== 이벤트 등록 ==================
    // 입력창에 글자를 입력할 때마다 높이 자동 조정
    inputEl.addEventListener("input", ()=>autoGrow(inputEl));

    // Enter만 누르면 전송, Shift+Enter는 줄바꿈
    inputEl.addEventListener("keydown", (e)=>{
        if(e.key==="Enter" && !e.shiftKey){
            e.preventDefault(); // 기본 줄바꿈 막기
            formEl.requestSubmit(); // 폼 제출 이벤트 실행
        }
    });

    // ================== 메시지 보내기 (서버와 통신) ==================
	// "보내기 버튼"을 누르거나, 입력창에서 Enter를 치면 <form>이 제출(submit)됨.
	// 이 이벤트를 가로채서 우리가 직접 처리하도록 함.
	formEl.addEventListener("submit", async (e)=>{
		e.preventDefault();  
		// 기본 동작(페이지 새로고침)을 막음 → 안 그러면 대화창이 새로고침돼버림.

		const q = inputEl.value.trim(); // 사용자가 입력한 텍스트 가져오기 (양쪽 공백 제거)
		if(!q) return;                  // 만약 아무 것도 안 썼으면 그냥 종료

		bubbleUser(q);                  // 내가 입력한 내용을 화면(말풍선)에 표시
		inputEl.value="";               // 입력창 내용 비우기
		autoGrow(inputEl);              // 입력창 높이 원래대로 초기화
		sendBtn.disabled = true;        // 버튼 잠시 비활성화 → 중복 클릭 방지
		const typingId = bubbleTyping();// AI가 "입력 중..." 이라고 표시하는 말풍선 추가

		try{
			// 서버에 요청을 보내다가 너무 오래 걸리면 강제로 중단시키기 위한 장치
			const ctrl = new AbortController(); 
			// TIMEOUT_MS(여기서는 120초)가 지나면 요청을 취소
			const to = setTimeout(()=>ctrl.abort('timeout'), TIMEOUT_MS);

			// 서버에 fetch(POST 요청) → JSON 형식으로 질문(q)을 보냄 <- 이부분으로 fetch가 진행
			const res = await fetch(CHAT_URL, {
				method: "POST",
				headers: {"Content-Type":"application/json"},
				body: JSON.stringify({message: q}), // {message: "사용자 질문"} 형태
				signal: ctrl.signal                 // 위에서 만든 취소 신호 연결
			});
			clearTimeout(to); // 정상 응답이 오면 타이머 중지

			// 서버가 "200 OK" 같은 정상 응답을 주지 않으면 에러 처리
			if(!res.ok){ 
				removeEl(typingId); // "입력 중..." 말풍선 제거
				return bubbleAI(`서버 오류(${res.status})`); 
				// 예) 500 오류 → "서버 오류(500)" 출력
			}

			// 서버가 보내준 JSON 데이터를 자바스크립트 객체로 변환
			const data = await res.json();
			removeEl(typingId); // "입력 중..." 제거
			// 서버에서 받은 답변(data.answer)을 AI 말풍선으로 출력
			// 만약 answer가 없으면 "응답이 비었습니다." 라고 표시
			bubbleAI(mdSafe(data.answer || "응답이 비었습니다."));

		}catch(err){
			// 네트워크 에러, 시간 초과 등 예외 발생 시 실행
			removeEl(typingId); // "입력 중..." 제거

			// 에러 메시지를 상황별로 보기 좋게 정리
			const msg = (
				err?.name === 'AbortError' || err === 'timeout' ||
				(typeof err?.message === 'string' && err.message.toLowerCase().includes('abort'))
			)
			// 요청 시간이 너무 길어서 중단된 경우
			? `요청이 ${Math.floor(TIMEOUT_MS/1000)}초를 초과해 중단됐어요. 잠시 후 다시 시도하거나 질문을 더 구체적으로 해보세요.`
			// 그 외 일반적인 실패 (네트워크 끊김 등)
			: ("요청 실패: " + (err?.message || err));

			// 에러 메시지를 AI 말풍선으로 출력
			bubbleAI(msg);
		}finally{
			// 성공이든 실패든 마지막에는 버튼 다시 활성화
			sendBtn.disabled = false; 
		}
	});


    // ================== 대화 초기화 버튼 ==================
    resetBtn.addEventListener("click", async ()=>{
        resetBtn.disabled = true;
        try{
            const res = await fetch(RESET_URL, { method:"POST" });
            if(res.ok) bubbleAI("대화 기록을 초기화했습니다.");
            else bubbleAI("초기화 실패.");
        }catch{ 
            bubbleAI("초기화 요청 실패."); 
        }
        finally{ 
            resetBtn.disabled = false; 
        }
    });
</script>


</body>
</html>
